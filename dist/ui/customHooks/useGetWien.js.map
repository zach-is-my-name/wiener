{"version":3,"file":"useGetWien.js","names":["React","useEffect","useState","got","cheerio","loadNewsletterFromDb","convertAndStore","fetchPermaLinkCurrent","useGetWien","loadState","ctrDispatch","hasLatestInArchive","hasInternet","dateFromSearch","setDateFromSearch","dateLatestPub","newsletterObj","setNewsletterObj","adjacentDates","setAdjacentDates","url","text","data","console","trace","$","load","attr","prevUrl","children","nextUrl","nlo","type","length","payload","date","Error"],"sources":["../../../src/ui/customHooks/useGetWien.js"],"sourcesContent":["import React, {useEffect, useState} from 'react'\nimport got from 'got'\nimport cheerio from 'cheerio' \nimport {loadNewsletterFromDb} from '../../db/db.js' \nimport {convertAndStore} from '../../transform/convert.js'\nimport {fetchPermaLinkCurrent} from '../../utilities.js'\n\nexport function useGetWien(loadState, ctrDispatch, hasLatestInArchive, hasInternet, dateFromSearch, setDateFromSearch, dateLatestPub) {\n  const [newsletterObj, setNewsletterObj] = useState(null)\n  const [adjacentDates, setAdjacentDates] = useState(null)\n\n  useEffect(() => {\n    if (loadState === \"fetchLatest\"){\n      (async () => {\n        let data \n        try {\n          let url = await fetchPermaLinkCurrent()\n          data = await got(url).text();\n        } catch (error) {\n          console.trace()\n          return \n        }\n\n        const $ = cheerio.load(data)\n        const url = $('link[rel=\"canonical\"]').attr('href')\n        let prevUrl = $('.nav-previous').children('a').attr('href');\n        let nextUrl = $('.nav-next').children('a').attr('href');\n        !nextUrl ? nextUrl = \"\" : nextUrl = nextUrl\n        setAdjacentDates({prevUrl, nextUrl})\n\n        const nlo  = await convertAndStore(data, url, prevUrl, nextUrl)\n        setNewsletterObj(nlo)\n        ctrDispatch({type: \"loadedFromFetchLatest\"})\n      })();\n\n    } else if (loadState === \"getArchiveMostRecent\") {\n      (async () => {\n        const nlo = await loadNewsletterFromDb(\"first\")\n        if (nlo === \"none\") {\n          ctrDispatch({type: \"none\"})\n        } else {\n          let prevUrl \n          let nextUrl \n          if (nlo?.prevUrl){\n            prevUrl = nlo.prevUrl\n          } else { \n            prevUrl = null\n          }\n\n          if (nlo?.nextUrl){\n            nextUrl = nlo.nextUrl\n          } else { \n            nextUrl = null\n          }\n          setAdjacentDates({prevUrl: prevUrl, nextUrl: nextUrl})\n          setNewsletterObj(nlo)\n          ctrDispatch({type: \"loadedFromGetArchiveMostRecent\"})\n        }\n      })();\n\n    } else if (loadState === \"loadNextHook\" && adjacentDates?.nextUrl?.length) {\n      (async () => {\n        const nlo = await loadNewsletterFromDb(\"url\", adjacentDates.nextUrl)\n\n        if (!nlo.prevUrl.length) {\n          ctrDispatch({type: \"setPopUpMessage\", payload: \"Missing some newsletter data (prevUrl date)...\"})\n          return\n        }\n        setAdjacentDates({prevUrl: nlo.prevUrl, nextUrl: nlo.nextUrl})\n        setNewsletterObj(nlo)\n        ctrDispatch({type: \"loadedFromNextButton\"})\n      })();\n\n    } else if (loadState === \"loadNextHook\" && newsletterObj.date === dateLatestPub) {\n      ctrDispatch({type: \"setPopUpMessage\", payload: \"Already at most recent published\"})\n      return \n\n    } else if (loadState === \"loadPrevHook\" && adjacentDates?.prevUrl?.length) {\n      (async () => {\n        const nlo = await loadNewsletterFromDb(\"url\", adjacentDates.prevUrl)\n        if (nlo.nextUrl.length === 0) {\n          ctrDispatch({type: \"setPopUpMessage\", payload: \"Missing some newsletter data (nextUrl date)\"})\n          return \n        } else {\n          setAdjacentDates({prevUrl: nlo.prevUrl, nextUrl: nlo.nextUrl})\n          setNewsletterObj(nlo)\n          ctrDispatch({type: \"loadedFromBackButton\"})\n        }\n      })();\n\n    } else if (loadState === 'loadFromSearch' && dateFromSearch?.length) {\n      (async () => {\n        const nlo = await loadNewsletterFromDb(\"date\", dateFromSearch)\n        if (!nlo.date.length) throw new Error()\n        setAdjacentDates({prevUrl: nlo.prevUrl, nextUrl: nlo.nextUrl})\n        setNewsletterObj(nlo)\n        setDateFromSearch(\"\")\n        ctrDispatch({type: \"loadedFromSearch\"})\n      })();\n    } else if (loadState === \"gotoLatestInArchive\") {\n      (async () => {\n        const nlo = await loadNewsletterFromDb(\"first\")\n        setAdjacentDates({prevUrl: nlo.prevUrl, nextUrl: nlo.nextUrl})\n        setNewsletterObj(nlo)\n        ctrDispatch({type: \"loadedFromGotoLatest\"})\n      })();\n    }\n  }, [loadState, dateFromSearch])\n\n  return newsletterObj\n}\n\n\n"],"mappings":"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"}