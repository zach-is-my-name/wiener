{"version":3,"file":"fetchBackFromLocalLatest.js","names":["chalk","url","got","cheerio","convertAndStore","getDateFromNewsletter","fetchPermaLinkCurrent","throttledGot","loadNewsletterFromDb","replaceBlankNextUrl","reqCount","fetchBackFromLocalLatest","dateLatestPub","fetchAndAdd","fetchedNewsletter","console","trace","Error","$","load","$url","attr","prevUrl","children","nextUrl","storedNewsletterObj","targetUrl","count","storedNewsletters","newsletterObj","find","obj","writtenNewsletterObj"],"sources":["../../src/fetch/fetchBackFromLocalLatest.js"],"sourcesContent":["#!/usr/bin/env node\nimport chalk from 'chalk';\nimport url from 'url'\nimport got from 'got'\nimport cheerio from 'cheerio'\nimport {convertAndStore} from '../transform/convert.js';\nimport {getDateFromNewsletter, fetchPermaLinkCurrent, throttledGot} from '../utilities.js'\nimport {loadNewsletterFromDb} from '../db/db.js'\n\nimport {replaceBlankNextUrl} from './replaceBlankNextUrl.js'\n\nlet reqCount\nexport async function fetchBackFromLocalLatest(dateLatestPub) {\n\n  let targetUrl = await fetchPermaLinkCurrent()\n  let count = -1\n  while (targetUrl) {\n    \n    let storedNewsletters = await loadNewsletterFromDb(\"all\")\n    count++\n    const newsletterObj = storedNewsletters.find(obj => obj.url === targetUrl)  \n    if (newsletterObj) {\n      targetUrl = newsletterObj.prevUrl\n    } else {\n      const writtenNewsletterObj = await fetchAndAdd(targetUrl) \n      targetUrl = writtenNewsletterObj.prevUrl \n    }\n    count++\n  }\n  \n  async function fetchAndAdd(url) {\n    if (url) {\n      let fetchedNewsletter \n      try {\n        fetchedNewsletter = await throttledGot(url)\n      } catch (error) {\n        console.trace()\n      }\n\n      reqCount++\n      if (typeof fetchedNewsletter !== 'string') return new Error(`error on fetched newsletter, value: ${fetchedNewsletter}`)\n      const $ = cheerio.load(fetchedNewsletter)\n      const $url = $('link[rel=\"canonical\"]').attr('href')\n      if ($url !== url) {return new Error(\"url wrong! debug!\")}\n      let prevUrl = $('.nav-previous').children('a').attr('href');\n      let nextUrl = $('.nav-next').children('a').attr('href');\n      !nextUrl ? nextUrl = \"\" : nextUrl = nextUrl\n      url === \"https://weekinethereumnews.com/january-4-2019/\" ? prevUrl = \"https://weekinethereumnews.com/december-28-2018/\" : prevUrl = prevUrl\n\n      const storedNewsletterObj = await convertAndStore(fetchedNewsletter, url, prevUrl, nextUrl) \n\n\n      return storedNewsletterObj \n    }\n\n    return  \n  }\n}\n\n"],"mappings":"AAAA;AAAmB;AAAA;AACnB,OAAOA,KAAK,MAAM,OAAO;AACzB,OAAOC,GAAG,MAAM,KAAK;AACrB,OAAOC,GAAG,MAAM,KAAK;AACrB,OAAOC,OAAO,MAAM,SAAS;AAC7B,SAAQC,eAAe,QAAO,yBAAyB;AACvD,SAAQC,qBAAqB,EAAEC,qBAAqB,EAAEC,YAAY,QAAO,iBAAiB;AAC1F,SAAQC,oBAAoB,QAAO,aAAa;AAEhD,SAAQC,mBAAmB,QAAO,0BAA0B;AAE5D,IAAIC,QAAQ;AACZ,gBAAsBC,wBAAwB;EAAA;AAAA;AA6C7C;EAAA,qFA7CM,kBAAwCC,aAAa;IAAA,8EAkB3CC,WAAW;IAAA;MAAA;QAAA;UAAA;YAAA,wEAA1B,iBAA2BZ,GAAG;cAAA;cAAA;gBAAA;kBAAA;oBAAA,KACxBA,GAAG;sBAAA;sBAAA;oBAAA;oBAAA;oBAAA;oBAAA,OAGuBM,YAAY,CAACN,GAAG,CAAC;kBAAA;oBAA3Ca,iBAAiB;oBAAA;oBAAA;kBAAA;oBAAA;oBAAA;oBAEjBC,OAAO,CAACC,KAAK,EAAE;kBAAA;oBAGjBN,QAAQ,EAAE;oBAAA,MACN,OAAOI,iBAAiB,KAAK,QAAQ;sBAAA;sBAAA;oBAAA;oBAAA,iCAAS,IAAIG,KAAK,+CAAwCH,iBAAiB,EAAG;kBAAA;oBACjHI,CAAC,GAAGf,OAAO,CAACgB,IAAI,CAACL,iBAAiB,CAAC;oBACnCM,IAAI,GAAGF,CAAC,CAAC,uBAAuB,CAAC,CAACG,IAAI,CAAC,MAAM,CAAC;oBAAA,MAChDD,IAAI,KAAKnB,GAAG;sBAAA;sBAAA;oBAAA;oBAAA,iCAAU,IAAIgB,KAAK,CAAC,mBAAmB,CAAC;kBAAA;oBACpDK,OAAO,GAAGJ,CAAC,CAAC,eAAe,CAAC,CAACK,QAAQ,CAAC,GAAG,CAAC,CAACF,IAAI,CAAC,MAAM,CAAC;oBACvDG,OAAO,GAAGN,CAAC,CAAC,WAAW,CAAC,CAACK,QAAQ,CAAC,GAAG,CAAC,CAACF,IAAI,CAAC,MAAM,CAAC;oBACvD,CAACG,OAAO,GAAGA,OAAO,GAAG,EAAE,GAAGA,OAAO,GAAGA,OAAO;oBAC3CvB,GAAG,KAAK,gDAAgD,GAAGqB,OAAO,GAAG,kDAAkD,GAAGA,OAAO,GAAGA,OAAO;oBAAA;oBAAA,OAEzGlB,eAAe,CAACU,iBAAiB,EAAEb,GAAG,EAAEqB,OAAO,EAAEE,OAAO,CAAC;kBAAA;oBAArFC,mBAAmB;oBAAA,iCAGlBA,mBAAmB;kBAAA;oBAAA;kBAAA;kBAAA;oBAAA;gBAAA;cAAA;YAAA,CAI7B;YAAA;UAAA;UA1BcZ,WAAW;YAAA;UAAA;UAAA;UAAA,OAhBJP,qBAAqB,EAAE;QAAA;UAAzCoB,SAAS;UACTC,KAAK,GAAG,CAAC,CAAC;QAAA;UAAA,KACPD,SAAS;YAAA;YAAA;UAAA;UAAA;UAAA,OAEgBlB,oBAAoB,CAAC,KAAK,CAAC;QAAA;UAArDoB,iBAAiB;UACrBD,KAAK,EAAE;UACDE,aAAa,GAAGD,iBAAiB,CAACE,IAAI,CAAC,UAAAC,GAAG;YAAA,OAAIA,GAAG,CAAC9B,GAAG,KAAKyB,SAAS;UAAA,EAAC;UAAA,KACtEG,aAAa;YAAA;YAAA;UAAA;UACfH,SAAS,GAAGG,aAAa,CAACP,OAAO;UAAA;UAAA;QAAA;UAAA;UAAA,OAEET,WAAW,CAACa,SAAS,CAAC;QAAA;UAAnDM,oBAAoB;UAC1BN,SAAS,GAAGM,oBAAoB,CAACV,OAAO;QAAA;UAE1CK,KAAK,EAAE;UAAA;UAAA;QAAA;QAAA;UAAA;MAAA;IAAA;EAAA,CA8BV;EAAA;AAAA"}